---
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import { marked } from 'marked'
import { supabase } from '../../lib/supabase'
import type { NewsArticle } from '../../lib/supabase'
import { Calendar, User, Tag, ArrowLeft, Share2, Clock } from 'lucide-astro'

export async function getStaticPaths() {
  try {
    const { data: articles, error } = await supabase
      .from('news')
      .select('slug, title')
      .eq('status', 'published')
    
    if (error) {
      console.error('Error fetching news articles for static paths:', error)
      return []
    }

    return (articles || []).map(article => ({
      params: { slug: article.slug },
      props: { slug: article.slug }
    }))
  } catch (error) {
    console.error('Error in getStaticPaths:', error)
    return []
  }
}

const { slug } = Astro.params

// Fetch the specific article
let article: NewsArticle | null = null
let relatedArticles: NewsArticle[] = []

try {
  const { data: articleData, error: articleError } = await supabase
    .from('news')
    .select(`
      *,
      category:categories(*),
      tags:news_tags(tag:tags(*))
    `)
    .eq('slug', slug)
    .eq('status', 'published')
    .single()
  
  if (articleError) {
    console.error('Error fetching article:', articleError)
  } else if (articleData) {
    article = {
      ...articleData,
      tags: articleData.tags?.map(t => t.tag).filter(Boolean) || []
    }
  }
} catch (error) {
  console.error('Error fetching article:', error)
}

// Fetch related articles if we have an article
if (article) {
  try {
    const { data: relatedData, error: relatedError } = await supabase
      .from('news')
      .select(`
        *,
        category:categories(*),
        tags:news_tags(tag:tags(*))
      `)
      .eq('status', 'published')
      .eq('category_id', article.category_id)
      .neq('id', article.id)
      .limit(3)
      .order('published_at', { ascending: false })
    
    if (relatedError) {
      console.error('Error fetching related articles:', relatedError)
    } else {
      relatedArticles = (relatedData || []).map(relatedArticle => ({
        ...relatedArticle,
        tags: relatedArticle.tags?.map(t => t.tag).filter(Boolean) || []
      }))
    }
  } catch (error) {
    console.error('Error fetching related articles:', error)
  }
}

// If article not found, return 404
if (!article) {
  return Astro.redirect('/404')
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

const readingTime = Math.ceil(article.content.split(' ').length / 200) // Estimate reading time

// Configure marked options for better HTML output
marked.setOptions({
  breaks: true, // Convert line breaks to <br>
  gfm: true, // Enable GitHub Flavored Markdown
})

// Convert Markdown content to HTML
const htmlContent = marked.parse(article.content)
---

<Layout 
  title={`${article.title} - International School`}
  description={article.excerpt || article.title}
  ogTitle={article.meta_title || article.title}
  ogDescription={article.meta_description || article.excerpt || article.title}
  ogImage={article.og_image_id ? `/images/news/${article.slug}-og.jpg` : `/images/news/${article.slug}.png`}
>
  <Header />
  
  <!-- Article Header -->
  <section class="py-8 bg-gray-50">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      
      <!-- Breadcrumb -->
      <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-6">
        <a href="/" class="hover:text-primary-600">Home</a>
        <span>/</span>
        <a href="/news" class="hover:text-primary-600">News</a>
        <span>/</span>
        <span class="text-gray-900">{article.title}</span>
      </nav>

      <!-- Back Button -->
      <div class="mb-6">
        <a 
          href="/news" 
          class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium"
        >
          <ArrowLeft class="h-4 w-4 mr-2" />
          Back to News
        </a>
      </div>

      <!-- Article Meta -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-6">
        <div class="flex items-center">
          <Calendar class="h-4 w-4 mr-2" />
          <time datetime={article.published_at}>
            {formatDate(article.published_at || article.created_at)}
          </time>
        </div>
        
        {article.category && (
          <div class="flex items-center">
            <Tag class="h-4 w-4 mr-2" />
            <span class="px-2 py-1 bg-primary-100 text-primary-800 rounded-full text-xs font-medium">
              {article.category.name}
            </span>
          </div>
        )}
        
        <div class="flex items-center">
          <Clock class="h-4 w-4 mr-2" />
          <span>{readingTime} min read</span>
        </div>
      </div>

      <!-- Article Title -->
      <h1 class="text-4xl font-bold text-gray-900 mb-4 leading-tight">
        {article.title}
      </h1>

      <!-- Article Excerpt -->
      {article.excerpt && (
        <p class="text-xl text-gray-600 mb-8 leading-relaxed">
          {article.excerpt}
        </p>
      )}
    </div>
  </section>

  <!-- Featured Image -->
  <section class="mb-8">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <div class="relative overflow-hidden rounded-xl shadow-lg">
        <img 
          src={`/images/news/${article.slug}.png`}
          alt={article.title}
          class="w-full h-96 object-cover"
          loading="eager"
        />
        
        <!-- Featured Badge -->
        {article.is_featured && (
          <div class="absolute top-4 right-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-500 text-white">
              Featured
            </span>
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Article Content -->
  <article class="py-8">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <div class="grid lg:grid-cols-4 gap-8">
        
        <!-- Main Content -->
        <div class="lg:col-span-3">
          <div class="prose prose-lg max-w-none">
            <!-- Render Markdown content as HTML -->
            <div set:html={htmlContent} />
          </div>

          <!-- Tags -->
          {article.tags && article.tags.length > 0 && (
            <div class="mt-8 pt-8 border-t border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Tags</h3>
              <div class="flex flex-wrap gap-2">
                {article.tags.map(tag => (
                  <a 
                    href={`/news/tag/${tag.slug}`}
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors duration-200"
                  >
                    {tag.name}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Share Buttons -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <Share2 class="h-5 w-5 mr-2" />
              Share this article
            </h3>
            <div class="flex space-x-4">
              <a 
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(article.title)}&url=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200"
              >
                Twitter
              </a>
              <a 
                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
              >
                Facebook
              </a>
              <a 
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors duration-200"
              >
                LinkedIn
              </a>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div class="sticky top-8 space-y-6">
            
            <!-- Article Info -->
            <div class="bg-gray-50 rounded-xl p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Article Information</h3>
              <div class="space-y-3 text-sm">
                <div>
                  <span class="text-gray-600">Published:</span>
                  <div class="font-medium text-gray-900">
                    {formatDate(article.published_at || article.created_at)}
                  </div>
                </div>
                
                {article.category && (
                  <div>
                    <span class="text-gray-600">Category:</span>
                    <div class="font-medium text-gray-900">
                      <a href={`/news/category/${article.category.slug}`} class="hover:text-primary-600">
                        {article.category.name}
                      </a>
                    </div>
                  </div>
                )}
                
                <div>
                  <span class="text-gray-600">Reading Time:</span>
                  <div class="font-medium text-gray-900">{readingTime} minutes</div>
                </div>
              </div>
            </div>

            <!-- Quick Links -->
            <div class="bg-white border border-gray-200 rounded-xl p-6">
              <h3 class="font-semibold text-gray-900 mb-4">Quick Links</h3>
              <div class="space-y-2">
                <a href="/news" class="block text-sm text-gray-600 hover:text-primary-600 transition-colors duration-200">
                  ← All News
                </a>
                <a href="/news#events" class="block text-sm text-gray-600 hover:text-primary-600 transition-colors duration-200">
                  Upcoming Events
                </a>
                <a href="/contact" class="block text-sm text-gray-600 hover:text-primary-600 transition-colors duration-200">
                  Contact Us
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Related Articles -->
  {relatedArticles.length > 0 && (
    <section class="py-16 bg-gray-50">
      <div class="mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Related Articles</h2>
        
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {relatedArticles.map(relatedArticle => (
            <article class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300">
              <div class="relative overflow-hidden">
                <img 
                  src={`/images/news/${relatedArticle.slug}.png`}
                  alt={relatedArticle.title}
                  class="w-full h-48 object-cover transition-transform duration-300 hover:scale-105"
                  loading="lazy"
                />
                
                {relatedArticle.category && (
                  <div class="absolute top-4 left-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-500 text-white">
                      {relatedArticle.category.name}
                    </span>
                  </div>
                )}
              </div>

              <div class="p-6">
                <div class="flex items-center text-sm text-gray-500 mb-3">
                  <Calendar class="h-4 w-4 mr-2" />
                  <time datetime={relatedArticle.published_at}>
                    {formatDate(relatedArticle.published_at || relatedArticle.created_at)}
                  </time>
                </div>

                <h3 class="text-xl font-bold text-gray-900 mb-3 line-clamp-2 hover:text-primary-600 transition-colors duration-200">
                  <a href={`/news/${relatedArticle.slug}`}>
                    {relatedArticle.title}
                  </a>
                </h3>

                {relatedArticle.excerpt && (
                  <p class="text-gray-600 mb-4 line-clamp-3">
                    {relatedArticle.excerpt}
                  </p>
                )}

                <a 
                  href={`/news/${relatedArticle.slug}`}
                  class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium text-sm"
                >
                  Read More
                  <ArrowLeft class="ml-1 h-4 w-4 rotate-180" />
                </a>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <Footer />
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .prose {
    color: #374151;
    line-height: 1.75;
  }

  .prose p {
    margin-bottom: 1.25em;
  }

  .prose h2 {
    font-size: 1.5em;
    font-weight: 700;
    margin-top: 2em;
    margin-bottom: 1em;
    color: #111827;
  }

  .prose h3 {
    font-size: 1.25em;
    font-weight: 600;
    margin-top: 1.6em;
    margin-bottom: 0.6em;
    color: #111827;
  }

  .prose ul, .prose ol {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }

  .prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }

  .prose blockquote {
    font-style: italic;
    border-left: 4px solid #10b981;
    padding-left: 1em;
    margin: 1.6em 0;
    color: #6b7280;
  }
</style>