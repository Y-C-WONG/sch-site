---
import Layout from '../../../layouts/Layout.astro'
import Header from '../../../components/Header.astro'
import Footer from '../../../components/Footer.astro'
import NewsCard from '../../../components/NewsCard.astro'
import { supabase } from '../../../lib/supabase'
import type { NewsArticle, Tag } from '../../../lib/supabase'
import { Hash, ArrowLeft } from 'lucide-astro'

export async function getStaticPaths() {
  try {
    const { data: tags, error } = await supabase
      .from('tags')
      .select('slug, name')
      .eq('is_active', true)
    
    if (error) {
      console.error('Error fetching tags for static paths:', error)
      return []
    }

    return (tags || []).map(tag => ({
      params: { slug: tag.slug },
      props: { slug: tag.slug }
    }))
  } catch (error) {
    console.error('Error in getStaticPaths:', error)
    return []
  }
}

const { slug } = Astro.params

// Fetch the tag
let tag: Tag | null = null
let articles: NewsArticle[] = []

try {
  const { data: tagData, error: tagError } = await supabase
    .from('tags')
    .select('*')
    .eq('slug', slug)
    .eq('is_active', true)
    .single()
  
  if (tagError) {
    console.error('Error fetching tag:', tagError)
  } else {
    tag = tagData
  }
} catch (error) {
  console.error('Error fetching tag:', error)
}

// Fetch articles with this tag
if (tag) {
  try {
    const { data: articlesData, error: articlesError } = await supabase
      .from('news')
      .select(`
        *,
        category:categories(*),
        tags:news_tags!inner(tag:tags(*))
      `)
      .eq('status', 'published')
      .eq('news_tags.tag_id', tag.id)
      .order('published_at', { ascending: false })
    
    if (articlesError) {
      console.error('Error fetching articles:', articlesError)
    } else {
      articles = (articlesData || []).map(article => ({
        ...article,
        tags: article.tags?.map(t => t.tag).filter(Boolean) || []
      }))
    }
  } catch (error) {
    console.error('Error fetching articles:', error)
  }
}

// If tag not found, return 404
if (!tag) {
  return Astro.redirect('/404')
}
---

<Layout 
  title={`${tag.name} Articles - International School`}
  description={`Browse all articles tagged with "${tag.name}" from International School. ${tag.description || ''}`}
>
  <Header />
  
  <!-- Tag Header -->
  <section class="py-16 bg-blue-500 text-white">
    <div class="mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8">
      
      <!-- Breadcrumb -->
      <nav class="flex items-center space-x-2 text-sm text-blue-100 mb-6">
        <a href="/" class="hover:text-white">Home</a>
        <span>/</span>
        <a href="/news" class="hover:text-white">News</a>
        <span>/</span>
        <span class="text-white">#{tag.name}</span>
      </nav>

      <div class="text-center">
        <div class="flex items-center justify-center mb-4">
          <Hash class="h-12 w-12 mr-4" />
          <h1 class="text-4xl font-bold">#{tag.name}</h1>
        </div>
        
        {tag.description && (
          <p class="text-xl text-blue-100 max-w-3xl mx-auto mb-6">
            {tag.description}
          </p>
        )}
        
        <div class="text-blue-100">
          {articles.length} {articles.length === 1 ? 'article' : 'articles'} with this tag
        </div>
      </div>
    </div>
  </section>

  <!-- Articles -->
  <section class="py-16 bg-gray-50">
    <div class="mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8">
      
      <!-- Back Button -->
      <div class="mb-8">
        <a 
          href="/news" 
          class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium"
        >
          <ArrowLeft class="h-4 w-4 mr-2" />
          Back to All News
        </a>
      </div>

      {articles.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {articles.map(article => (
            <NewsCard article={article} />
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <Hash class="h-16 w-16 text-gray-300 mx-auto mb-4" />
          <h3 class="text-xl font-semibold text-gray-900 mb-2">No articles found</h3>
          <p class="text-gray-600 mb-6">
            There are currently no published articles tagged with "{tag.name}".
          </p>
          <a 
            href="/news" 
            class="inline-flex items-center px-6 py-3 bg-primary-500 text-white font-medium rounded-lg hover:bg-primary-600 transition-colors duration-200"
          >
            Browse All News
          </a>
        </div>
      )}
    </div>
  </section>

  <Footer />
</Layout>